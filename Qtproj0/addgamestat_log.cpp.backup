#include "addgamestat_log.h"
#include "ui_addgamestat_log.h"
#include "playerselectdialog.h"
#include <QMessageBox>
#include <QCompleter>
#include <QStringList>
#include <QTableWidget>
#include <QTableWidgetItem>
#include <QHeaderView>

AddGameStat_Log::AddGameStat_Log(DataManage* dataManager, QWidget *parent)
    : QDialog(parent)
    , ui(new Ui::AddGameStat_Log)
    , m_dataManager(dataManager)
    , m_currentGameId(m_dataManager->getNextGameId())
{
    ui->setupUi(this);
    setupUI();
    setupConnections();
}

AddGameStat_Log::~AddGameStat_Log()
{
    delete ui;
}

void AddGameStat_Log::setupUI()
{
    // Set window size and title
    setFixedSize(800, 600);
    setWindowTitle("添加比赛统计");
    
    // Configure table
    ui->playersTable->setColumnCount(7);
    QStringList headers;
    headers << "姓名" << "队伍" << "得分" << "三分球" 
            << "篮板" << "扣篮" << "抢断";
    ui->playersTable->setHorizontalHeaderLabels(headers);
    ui->playersTable->horizontalHeader()->setStretchLastSection(true);
    
    // Set up team combo box
    QStringList teams;
    teams << "湖人队" << "勇士队" << "公牛队" << "凯尔特人队" << "热火队" << "马刺队" << "尼克斯队" << "篮网队";
    ui->teamComboBox->addItems(teams);
    
    // Set up auto-completion for player names
    QStringList playerNames = m_dataManager->getAllPlayerNames();
    QCompleter *completer = new QCompleter(playerNames, this);
    completer->setCaseSensitivity(Qt::CaseInsensitive);
    ui->nameLineEdit->setCompleter(completer);
    
    // Set status message
    ui->statusLabel->setText("准备添加球员统计数据");
}

void AddGameStat_Log::setupConnections()
{
    // Connect buttons
    connect(ui->selectPresetButton, &QPushButton::clicked, this, &AddGameStat_Log::selectPresetPlayers);
    connect(ui->addPlayerButton, &QPushButton::clicked, this, &AddGameStat_Log::addPlayer);
    connect(ui->clearInputsButton, &QPushButton::clicked, this, &AddGameStat_Log::clearInputs);
    connect(ui->finishButton, &QPushButton::clicked, this, &AddGameStat_Log::saveGameData);
    connect(ui->cancelButton, &QPushButton::clicked, this, &AddGameStat_Log::reject);
}

void AddGameStat_Log::addPlayer()
{
    QString name = ui->nameLineEdit->text().trimmed();
    QString team = ui->teamComboBox->currentText();
    
    if (name.isEmpty()) {
        QMessageBox::warning(this, "警告", "请输入球员姓名！");
        return;
    }
    
    // Check if player already exists in current game
    for (int i = 0; i < ui->playersTable->rowCount(); ++i) {
        if (ui->playersTable->item(i, 0) && 
            ui->playersTable->item(i, 0)->text() == name) {
            // Update existing player
            ui->playersTable->setItem(i, 1, new QTableWidgetItem(team));
            ui->playersTable->setItem(i, 2, new QTableWidgetItem(QString::number(ui->pointsSpinBox->value())));
            ui->playersTable->setItem(i, 3, new QTableWidgetItem(QString::number(ui->threePointsSpinBox->value())));
            ui->playersTable->setItem(i, 4, new QTableWidgetItem(QString::number(ui->reboundsSpinBox->value())));
            ui->playersTable->setItem(i, 5, new QTableWidgetItem(QString::number(ui->dunksSpinBox->value())));
            ui->playersTable->setItem(i, 6, new QTableWidgetItem(QString::number(ui->stealsSpinBox->value())));
            
            ui->statusLabel->setText(QString("已更新球员: %1").arg(name));
            clearInputs();
            return;
        }
    }
    
    // Add new row to table
    int row = ui->playersTable->rowCount();
    ui->playersTable->insertRow(row);
    
    // Set player data
    ui->playersTable->setItem(row, 0, new QTableWidgetItem(name));
    ui->playersTable->setItem(row, 1, new QTableWidgetItem(team));
    ui->playersTable->setItem(row, 2, new QTableWidgetItem(QString::number(ui->pointsSpinBox->value())));
    ui->playersTable->setItem(row, 3, new QTableWidgetItem(QString::number(ui->threePointsSpinBox->value())));
    ui->playersTable->setItem(row, 4, new QTableWidgetItem(QString::number(ui->reboundsSpinBox->value())));
    ui->playersTable->setItem(row, 5, new QTableWidgetItem(QString::number(ui->dunksSpinBox->value())));
    ui->playersTable->setItem(row, 6, new QTableWidgetItem(QString::number(ui->stealsSpinBox->value())));
    
    // Update status
    ui->statusLabel->setText(QString("已添加球员: %1. 总计球员: %2")
                            .arg(name).arg(ui->playersTable->rowCount()));
    clearInputs();
}

void AddGameStat_Log::clearInputs()
{
    ui->nameLineEdit->clear();
    ui->teamComboBox->setCurrentIndex(0);
    ui->pointsSpinBox->setValue(0);
    ui->threePointsSpinBox->setValue(0);
    ui->reboundsSpinBox->setValue(0);
    ui->dunksSpinBox->setValue(0);
    ui->stealsSpinBox->setValue(0);
    ui->nameLineEdit->setFocus();
}

void AddGameStat_Log::saveGameData()
{
    QString gameName = ui->gameNameEdit->text().trimmed();
    
    if (gameName.isEmpty()) {
        QMessageBox::warning(this, "警告", "请输入比赛名称！");
        ui->gameNameEdit->setFocus();
        return;
    }
    
    if (ui->playersTable->rowCount() == 0) {
        QMessageBox::warning(this, "警告", "请至少添加一名球员！");
        return;
    }
    
    // Validate and save data
    QVector<PlayerStats> gameData;
    
    for (int row = 0; row < ui->playersTable->rowCount(); ++row) {
        PlayerStats stats;
        
        // Set game info using setters
        stats.setGameId(m_currentGameId);
        stats.setGameName(gameName);
        stats.setDate(ui->dateEdit->date());
        
        // Get player data using setters
        if (ui->playersTable->item(row, 0)) {
            stats.setName(ui->playersTable->item(row, 0)->text());
        }
        
        if (ui->playersTable->item(row, 1)) {
            stats.setTeam(ui->playersTable->item(row, 1)->text());
        }
        
        // Get statistics using setters
        bool ok;
        if (ui->playersTable->item(row, 2)) {
            int points = ui->playersTable->item(row, 2)->text().toInt(&ok);
            stats.setPoints(ok ? points : 0);
        }
        
        if (ui->playersTable->item(row, 3)) {
            int threePoints = ui->playersTable->item(row, 3)->text().toInt(&ok);
            stats.setThreePoints(ok ? threePoints : 0);
        }
        
        if (ui->playersTable->item(row, 4)) {
            int rebounds = ui->playersTable->item(row, 4)->text().toInt(&ok);
            stats.setRebounds(ok ? rebounds : 0);
        }
        
        if (ui->playersTable->item(row, 5)) {
            int dunks = ui->playersTable->item(row, 5)->text().toInt(&ok);
            stats.setDunks(ok ? dunks : 0);
        }
        
        if (ui->playersTable->item(row, 6)) {
            int steals = ui->playersTable->item(row, 6)->text().toInt(&ok);
            stats.setSteals(ok ? steals : 0);
        }
        
        gameData.append(stats);
    }
    
    // Save to data manager
    if (m_dataManager->addGameStats(gameData)) {
        QMessageBox::information(this, "成功", 
                               QString("比赛数据保存成功！\n比赛: %1\n球员数: %2")
                               .arg(gameName).arg(gameData.size()));
        accept();
    } else {
        QMessageBox::critical(this, "错误", "保存比赛数据失败！");
    }
}

void AddGameStat_Log::selectPresetPlayers()
{
    PlayerSelectDialog dialog(m_dataManager, this);
    if (dialog.exec() == QDialog::Accepted) {
        QVector<PlayerStats> selectedPlayers = dialog.getSelectedPlayers();
        
        for (const PlayerStats& player : selectedPlayers) {
            // Check if player already exists
            bool exists = false;
            for (int i = 0; i < ui->playersTable->rowCount(); ++i) {
                if (ui->playersTable->item(i, 0) && 
                    ui->playersTable->item(i, 0)->text() == player.getName()) {
                    exists = true;
                    break;
                }
            }
            
            if (!exists) {
                int row = ui->playersTable->rowCount();
                ui->playersTable->insertRow(row);
                
                // Set player info
                ui->playersTable->setItem(row, 0, new QTableWidgetItem(player.getName()));
                ui->playersTable->setItem(row, 1, new QTableWidgetItem(player.getTeam()));
                ui->playersTable->setItem(row, 2, new QTableWidgetItem("0")); // points
                ui->playersTable->setItem(row, 3, new QTableWidgetItem("0")); // threePoints
                ui->playersTable->setItem(row, 4, new QTableWidgetItem("0")); // rebounds
                ui->playersTable->setItem(row, 5, new QTableWidgetItem("0")); // dunks
                ui->playersTable->setItem(row, 6, new QTableWidgetItem("0")); // steals
            }
        }
        
        // Update status (need to add status label functionality)
        if (!selectedPlayers.isEmpty()) {
            QMessageBox::information(this, "成功", 
                                   QString("已添加 %1 名预设球员")
                                   .arg(selectedPlayers.size()));
        }
    }
}
